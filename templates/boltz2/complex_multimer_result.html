{% extends "base.html" %}
{% block style %}
#summary-bar {
  font-size: 1.1rem;
  background: #f0f0f0;
  padding: 10px 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.summary-section .card {
    height: 100%;
}
.summary-section .card-header {
  font-size: 1.1rem;
  font-weight: 600;
}
#summary-3dviewer {
    position: relative;
    z-index: 0;
    height: 400px;
    width: 100%;
    overflow: hidden;
}
.card-body {
    position: relative;
}
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-primary mb-4">ğŸ§¬ Boltz 3D Virtual Results</h2>

  <div class="summary-section row mb-5">
    <div class="col-md-12 mx-auto">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <div class="p-1 d-flex flex-wrap gap-3 align-items-center">
            
            <div class="ms-auto d-flex gap-2">
              <button class="btn btn-sm btn-outline-dark" onclick="setStyleCartoon()">White</button>
              <button class="btn btn-sm btn-outline-dark" onclick="setStyleStick()">Stick</button>
              <button class="btn btn-sm btn-outline-dark" onclick="resetStyleCartoon()">Cartoon</button>
              <button class="btn btn-sm btn-outline-dark" onclick="toggleSpin()">Spin</button>
              <button class="btn btn-sm btn-outline-dark" onclick="resetZoom()">Reset Zoom</button>
            </div>
            
          </div>
        </div>
        <div class="card-body p-0">
          <!-- ğŸ”¹ 3D viewer ì˜ì—­ -->
          <div id="viewer" style="width: 100%; height: 900px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const viewer = $3Dmol.createViewer("viewer", { backgroundColor: "white" });

  // ğŸ”¸ ì„œë²„ì—ì„œ ì „ë‹¬ëœ PDB ë¦¬ìŠ¤íŠ¸ (ì¤„ë°”ê¿ˆ ë“± escape ì²˜ë¦¬)
  const pdbStr = `{{ result_pdbs|escapejs }}`;  // â† JSON ë¬¸ìì—´ì´ë‹ˆê¹Œ ê·¸ëƒ¥ JS ë°°ì—´ë¡œ ë°”ë¡œ ë¨!

  // ğŸ”¸ í¬ì¦ˆ ë¡œë“œ í•¨ìˆ˜
  function loadPose(index = null) {
    viewer.clear();
    viewer.addModel(pdbStr, "pdb");
    const model = viewer.getModel();  // ğŸ”¹ getModel()ì€ viewerì—ì„œ ì²« ë²ˆì§¸ ëª¨ë¸ ë°˜í™˜
  
    viewer.setStyle({ hetflag: false }, { cartoon: { colorfunc: function(atom) {
                                                                  const chainColors = {
                                                                    A: "white",
                                                                    B: "green",
                                                                    C: "blue",
                                                                    D: "orange",
                                                                    E: "purple",
                                                                    F: "red"
                                                                  };
                                                                  return chainColors[atom.chain] || "gray";
                                                                }
                                                    } 
                                        });  // ë‹¨ë°±ì§ˆ
    viewer.setStyle({ hetflag: true }, { stick: { color: 'magenta' }, sphere: { radius: 0.4 } });  // ë¦¬ê°„ë“œ
  
    viewer.zoomTo();
    viewer.render();
  }

  // ğŸ”¸ ìŠ¤íƒ€ì¼ ì»¨íŠ¸ë¡¤ í•¨ìˆ˜
  function setStyleCartoon() {
    viewer.setStyle({}, { cartoon: { color: "white" } });
    viewer.setStyle({ hetflag: true }, { stick: { color: 'magenta' }, sphere: { radius: 0.4 } });  // ë¦¬ê°„ë“œ
    viewer.render();
  }

  function resetStyleCartoon() {
    viewer.setStyle({}, { cartoon: { color: "spectrum" } });
    viewer.setStyle({ hetflag: true }, { stick: { color: 'magenta' }, sphere: { radius: 0.4 } });  // ë¦¬ê°„ë“œ
    viewer.render();
  }

  function setStyleStick() {
    viewer.setStyle({}, { stick: { radius: 0.3 } });
    viewer.setStyle({ hetflag: true }, { stick: { color: 'magenta' }, sphere: { radius: 0.4 } });  // ë¦¬ê°„ë“œ
    viewer.render();
  }

  let isSpinning = false;
  function toggleSpin() {
    isSpinning = !isSpinning;
    viewer.spin(isSpinning);  // â† ì´ê²ƒë§Œ ì‚¬ìš©!
  }

  function resetZoom() {
    viewer.setStyle({ hetflag: false }, { cartoon: { colorfunc: function(atom) {
                                                                  const chainColors = {
                                                                    A: "white",
                                                                    B: "green",
                                                                    C: "blue",
                                                                    D: "orange",
                                                                    E: "purple",
                                                                    F: "red"
                                                                  };
                                                                  return chainColors[atom.chain] || "gray";
                                                                }
                                                    } 
                                         });  // ë‹¨ë°±ì§ˆ
    viewer.setStyle({ hetflag: true }, { stick: { color: 'magenta' }, sphere: { radius: 0.4 } });  // ë¦¬ê°„ë“œ
    viewer.zoomTo();
    viewer.render();
  }

  // ğŸ”¸ ì²« ë²ˆì§¸ í¬ì¦ˆ ë¡œë”©
  loadPose(0);
</script>
{% endblock %}