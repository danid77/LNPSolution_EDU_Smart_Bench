{% extends "base.html" %}

{% block style %}
#sample-list-buttons {
  display: flex;
  flex-wrap: wrap;       /* Ï§Ñ Î∞îÍøà Í∞ÄÎä• */
  gap: 10px;              /* Î≤ÑÌäº Í∞ÑÍ≤© */
}

#sample-list-buttons .btn {
  flex: 1 1 0;
  min-width: 120px;       /* Î≤ÑÌäº ÏµúÏÜå ÎÑàÎπÑ */
  text-align: center;
}

{% endblock %}

{% load static %}

{% block content %}
<div class="container-fluid p-4" style="min-height: 100vh; background-color: #f9f9f9;">

    <div class="summary-section row mb-5">

        <!-- üî∏ 3Dmol.js Î∑∞Ïñ¥ Ïπ¥Îìú -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light">
                    <div class="p-1 d-flex flex-wrap gap-3 align-items-center">
                        <label class="form-label mb-0 me-2"><strong>üß¨ 3D Protein-Ligand Structure</strong></label>
              
                        <div class="ms-auto d-flex gap-2">
                          <button class="btn btn-sm btn-outline-dark" onclick="setStyleCartoon()">White</button>
                          <button class="btn btn-sm btn-outline-dark" onclick="setStyleStick()">Stick</button>
                          <button class="btn btn-sm btn-outline-dark" onclick="resetStyleCartoon()">Cartoon</button>
                          <button class="btn btn-sm btn-outline-dark" onclick="toggleSpin()">Spin</button>
                          <button class="btn btn-sm btn-outline-dark" onclick="resetZoom()">Reset Zoom</button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="summary-3dviewer" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>
        <!-- üîπ 2D Ïù¥ÎØ∏ÏßÄ Ïπ¥Îìú -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light"><strong>üñºÔ∏è  Plip : Ligand Image</strong></div>
                <div class="card-body d-flex justify-content-center align-items-center" style="height: 400px;">
                    <img id="summary-image" class="img-fluid" style="height: 550px; width: auto;" alt="2D Ligand Image" onclick="openImageModal(this.src)">
                </div>
            </div>
        </div>
    </div>
    <div class="summary-section row mb-5">
        <div id="gnina-table-container"></div>
    </div>

    <div class="summary-section row mb-5">
        <div class="col-md-12">
          <div id="interaction-content"></div>
        </div>
      </div>

</div>

<!-- Ïù¥ÎØ∏ÏßÄ ÌÅ¥Î¶≠ Ïãú ÌôïÎåÄÎêòÎäî Î™®Îã¨ -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-body p-0">
          <img id="modalImage" src="" class="img-fluid w-100" alt="Expanded View">
        </div>
      </div>
    </div>
</div>

<!-- SMILES Íµ¨Ï°∞ ÌôïÎåÄ Î™®Îã¨ -->
<div class="modal fade" id="structureModal" tabindex="-1" aria-labelledby="structureModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-body text-center">
        <canvas id="modalCanvas" width="400" height="400"></canvas>
        <div id="modalSmiles" class="mt-2"><code></code></div>
      </div>
    </div>
  </div>
</div>

<script>
  // const sampleList = JSON.parse(`{{ sample_list|safe }}`);
  // const pdbContent = `{{ result_pdb|escapejs }}`;
  const resultsDir = "{{ results_dir }}";

  const viewer = $3Dmol.createViewer("summary-3dviewer", { backgroundColor: "white" });

  const pdbStr = `{{ result_pdb|escapejs }}`;  // ‚Üê JSON Î¨∏ÏûêÏó¥Ïù¥ÎãàÍπå Í∑∏ÎÉ• JS Î∞∞Ïó¥Î°ú Î∞îÎ°ú Îê®!

    // üî∏ Ìè¨Ï¶à Î°úÎìú Ìï®Ïàò
  function loadPose(index = null) {
    viewer.clear();
    viewer.addModel(pdbStr, "pdb");
    const model = viewer.getModel();  // üîπ getModel()ÏùÄ viewerÏóêÏÑú Ï≤´ Î≤àÏß∏ Î™®Îç∏ Î∞òÌôò
  
    viewer.setStyle({ hetflag: false }, { cartoon: { color: 'white' } });  // Îã®Î∞±Ïßà
    viewer.setStyle({ hetflag: true }, { stick: { color: 'magenta' }, sphere: { radius: 0.4 } });  // Î¶¨Í∞ÑÎìú
  
    viewer.zoomTo();
    viewer.render();

    loadResults(resultsDir);
  }

  // üî∏ Ïä§ÌÉÄÏùº Ïª®Ìä∏Î°§ Ìï®Ïàò
  function setStyleCartoon() {
    viewer.setStyle({}, { cartoon: { color: "white" } });
    viewer.setStyle({ hetflag: true }, { stick: { color: 'magenta' }, sphere: { radius: 0.4 } });  // Î¶¨Í∞ÑÎìú
    viewer.render();
  }

  function resetStyleCartoon() {
    viewer.setStyle({}, { cartoon: { color: "spectrum" } });
    viewer.setStyle({ hetflag: true }, { stick: { color: 'magenta' }, sphere: { radius: 0.4 } });  // Î¶¨Í∞ÑÎìú
    viewer.render();
  }

  function setStyleStick() {
    viewer.setStyle({}, { stick: { radius: 0.3 } });
    viewer.setStyle({ hetflag: true }, { stick: { color: 'magenta' }, sphere: { radius: 0.4 } });  // Î¶¨Í∞ÑÎìú
    viewer.render();
  }

  let isSpinning = false;
  function toggleSpin() {
    isSpinning = !isSpinning;
    viewer.spin(isSpinning);  // ‚Üê Ïù¥Í≤ÉÎßå ÏÇ¨Ïö©!
  }

  function resetZoom() {
    viewer.setStyle({ hetflag: false }, { cartoon: { color: 'spectrum' } });  // Îã®Î∞±Ïßà
    viewer.setStyle({ hetflag: true }, { stick: { color: 'magenta' }, sphere: { radius: 0.4 } });  // Î¶¨Í∞ÑÎìú
    viewer.zoomTo();
    viewer.render();
  }

  // üî∏ Ï≤´ Î≤àÏß∏ Ìè¨Ï¶à Î°úÎî©
  loadPose(0);

  function loadResults(resultsDir) {
    const relativePath = resultsDir.split("/static/")[1];
    const imageUrl = `{% url 'visualzing:visualzingPlipResultImages' %}?mainResultsDir=${encodeURIComponent(resultsDir)}`;
    fetch(imageUrl)
    .then(res => res.json())
    .then(data => {
        if (data.plip_image) {
            const img = document.getElementById("summary-image");
            img.src = `/static/${relativePath}/plip/${data.plip_image}`;
            img.alt = data.plip_image;
        }
    });

    // XML ÌååÏã±Ìï¥ÏÑú Ïπ¥Îìú ÏïàÏóê ÏÉÅÌò∏ÏûëÏö© ÌëúÎ°ú ÎÑ£Í∏∞
    fetch(`{% url 'plip:plipResultXml' %}?results_dir=${encodeURIComponent(resultsDir)}/plip`)
    .then(res => res.json())
    .then(data => {
        if (data.sites) {
            const container = document.getElementById("interaction-content");

            data.sites.forEach(site => {
                const ligand = site.ligand;

                // ‚úÖ Ïπ¥Îìú 1: Ligand Info
                const ligandCard = document.createElement("div");
                ligandCard.className = "card shadow-sm mb-4";
                ligandCard.innerHTML = `
                    <div class="card-header bg-light">
                        <strong>üß≤ Binding Site - Ligand <code>${ligand.longname}</code></strong>
                    </div>
                    <div class="card-body">
                        <ul class="mb-3">
                            <li><strong>HETID:</strong> ${ligand.hetid}</li>
                            <li><strong>Chain:</strong> ${ligand.chain}</li>
                            <li><strong>Position:</strong> ${ligand.position}</li>
                            <li><strong>SMILES:</strong> <code>${ligand.smiles}</code></li>
                            <li><strong>InChIKey:</strong> <code>${ligand.inchikey}</code></li>
                        </ul>
                    </div>
                `;
                container.appendChild(ligandCard);

                // ‚úÖ Ïπ¥Îìú 2: Hydrogen Bonds
                if (site.hydrogen_bonds.length > 0) {
                    const hbondCard = document.createElement("div");
                    hbondCard.className = "card shadow-sm mb-4";

                    hbondCard.innerHTML = `
                        <div class="card-header bg-light">
                            <strong>üî¨ Hydrogen Bonds</strong>
                        </div>
                        <div class="card-body table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Residue</th>
                                        <th>Distance D-A</th>
                                        <th>Angle</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${site.hydrogen_bonds.map(h => `
                                        <tr>
                                            <td>${h.restype} ${h.resnr} (${h.reschain})</td>
                                            <td>${h["dist_d-a"]}</td>
                                            <td>${h.don_angle}</td>
                                        </tr>`).join("")}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.appendChild(hbondCard);
                }

                // ‚úÖ Ïπ¥Îìú 3: Pi Stacks
                if (site.pi_stacks.length > 0) {
                    const piCard = document.createElement("div");
                    piCard.className = "card shadow-sm mb-4";

                    piCard.innerHTML = `
                        <div class="card-header bg-light">
                            <strong>üß± Pi Stacks</strong>
                        </div>
                        <div class="card-body table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Residue</th>
                                        <th>Type</th>
                                        <th>Distance</th>
                                        <th>Angle</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${site.pi_stacks.map(p => `
                                        <tr>
                                            <td>${p.restype} ${p.resnr} (${p.reschain})</td>
                                            <td>${p.type}</td>
                                            <td>${p.centdist}</td>
                                            <td>${p.angle}</td>
                                        </tr>`).join("")}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.appendChild(piCard);
                }
            });
        }
    });

    // üîπ Gnina Ï†êÏàò ÌÖåÏù¥Î∏î Î∂àÎü¨Ïò§Í∏∞
    fetch(`{% url 'visualzing:visualzingGninaScore' %}?mainResultsDir=${encodeURIComponent(resultsDir)}`)
    .then(res => res.json())
    .then(data => {
    if (data.columns && data.data) {
        const tableContainer = document.getElementById("gnina-table-container");

        // ÌÖåÏù¥Î∏î Íµ¨ÏÑ±
        const table = document.createElement("table");
        table.className = "table table-striped table-bordered";

        // Ìó§Îçî ÏÉùÏÑ±
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        data.columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        headRow.appendChild(th);
        });
        thead.appendChild(headRow);

        // Î∞îÎîî ÏÉùÏÑ±
        const tbody = document.createElement("tbody");
        data.data.forEach(row => {
        const tr = document.createElement("tr");
        data.columns.forEach(col => {
            const td = document.createElement("td");
            td.textContent = row[col];
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);

        // Ïπ¥Îìú ÌòïÌÉúÎ°ú Í∞êÏã∏Í∏∞
        const card = document.createElement("div");
        card.className = "card shadow-sm h-100";
        card.innerHTML = `
        <div class="card-header bg-light">
            <strong>üìä Gnina Scoring Result</strong>
        </div>
        <div class="card-body table-responsive">
        </div>
        `;
        card.querySelector(".card-body").appendChild(table);
        tableContainer.appendChild(card);
    }
    });
}

  function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
  }
</script>
    
{% endblock %}